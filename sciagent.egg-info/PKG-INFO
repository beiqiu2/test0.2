Metadata-Version: 2.4
Name: sciagent
Version: 0.1.0
Summary: RunGuardian / Sci Pilot CLI toolkit for guarding training runs
Requires-Python: >=3.10
Description-Content-Type: text/markdown
Requires-Dist: typer>=0.9.0
Requires-Dist: pyyaml>=6.0
Requires-Dist: omegaconf>=2.3.0
Requires-Dist: jsonlines>=4.0.0
Requires-Dist: matplotlib>=3.7.0
Requires-Dist: rich>=13.0.0

# RunGuardian / SciPilot 总览

RunGuardian / SciPilot（以下简称 *SciAgent*）是一套零侵入、可复用、易演示的训练“黑盒包装器”。它以“一条命令包裹任意 `python train.py`”为核心理念，帮助科研人员和竞赛团队解决以下痛点：

- 参数复现困难：训练命令、配置和环境信息分散在命令行、脚本和口述中，几周后就忘了为何指标提升。
- 训练易中断：OOM、断电或误按 `Ctrl+C` 会让数小时训练成果付诸东流。
- 缺乏系统复盘：日志堆积却没人总结，下一步优化全靠感觉。
- 平台迁移成本高：MLflow / W&B 等平台功能强大，但接入成本、账号体系、代码侵入都较高。

SciAgent 通过“记录、守护、复盘、建议”四步闭环帮助你稳住实验过程、沉淀实验资产。

---

## 功能矩阵与里程碑状态

| 里程碑 | 能力描述 | 当前状态 | 关键输出 |
| --- | --- | --- | --- |
| **M0 能跑** | CLI 包裹训练并生成标准化 Run 目录 | ✅ 已实现 | `cmd.txt` `config.json` `env.json` `stdout.log` `logs_tail.txt` `metrics.jsonl` |
| **M1 能比** | 配置指纹（SHA256）与 Diff 引擎 | ⏳ 规划中 | `fingerprint.txt` `sciagent diff` |
| **M2 能救** | OOM / `Ctrl+C` 自救，写入 `last.ckpt` `resume.json` | ⏳ 规划中 | 中断留存与恢复提示 |
| **M3 能记** | 自动快照、主指标 `best.ckpt`、限额控制 | ⏳ 规划中 | `checkpoints/` 与 `run_meta.json` |
| **M4 能报** | 自动产出 `report.md` + `curves.png` | ⏳ 规划中 | 一页读懂表现、异常和建议 |
| **M5 LLM 建议** | 指标 & Diff 驱动的三条可执行建议 | 🔭 规划中 | 可选打开，避免空话 |

当前仓库已经交付 **M0 基础能力**，其余里程碑在 README 中给出设计思路，便于团队迭代。

---

## 安装与环境准备

### 1. 准备 Python 环境

建议使用 Python 3.10+，Windows PowerShell 示例：

```powershell
cd D:\CursorProgram\test_2
python -m venv .venv
.venv\Scripts\Activate
pip install --upgrade pip
pip install -e .
```

安装过程会拉取以下核心依赖：

- `typer`：构建 CLI。
- `pyyaml` / `omegaconf`：解析多源配置。
- `jsonlines`：记录指标流。
- `matplotlib`：绘制曲线（M4 使用）。
- `rich`：终端交互与格式化输出。

### 2. GPU 训练所需的 PyTorch

若使用 GPU，可根据显卡与 CUDA 版本安装对应的 PyTorch。示例（CUDA 12.6）：

```powershell
pip uninstall -y torch torchvision        # 若已安装 CPU 版
pip install torch torchvision --index-url https://download.pytorch.org/whl/cu126
```

安装完成后，包会位于当前 Python 解释器的 `Lib\site-packages` 目录（例如 `C:\Users\<username>\AppData\Local\Programs\Python\Python313\Lib\site-packages`）。

---

## 快速体验

### 1. 包裹示例训练脚本

仓库内置多个例程，可快速验证功能：

```powershell
# JSONL 指标流（推荐）
sciagent --cmd "python examples/train_dummy.py --lr 3e-4 --bs 32" --workdir ./exp --name run_dummy

# stdout 文本日志
sciagent --cmd "python examples/train_stdout_style.py --lr 5e-4 --bs 16" --workdir ./exp --name run_stdout

# 故障演示（第 80 步模拟 OOM）
sciagent --cmd "python examples/train_crash.py" --workdir ./exp --name run_crash
```

### 2. 包裹真实脚本 `main_train.py`

```powershell
sciagent --cmd "python main_train.py" --workdir ./exp --name main_train --encoding gbk
```

说明：

- Windows 中文终端常使用 GBK 编码，训练脚本若输出中文需通过 `--encoding gbk` 保证日志解析正常。
- 如果脚本强依赖 CUDA，请确认 GPU 版 PyTorch 已安装；否则在检测 GPU 时可能抛出 `Torch not compiled with CUDA enabled`。

### 3. 运行目录结构

每次运行会在 `--workdir`（默认 `./exp`）下创建 `runs/<timestamp>_<name>/` 目录，记录所有资产。M0 下目录示例：

```
exp/
└── runs/
    └── 2025-11-12_10-37-27_main_train/
        ├── cmd.txt              # 原始命令
        ├── config.json          # CLI + 配置文件合成后的配置树
        ├── env.json             # Python/GPU/Git 信息
        ├── logs_tail.txt        # stdout 最近 N（默认 200）行
        ├── stdout.log           # 全量 stdout
        └── metrics.jsonl        # 自动识别的 JSONL 指标（若存在）
```

后续里程碑会在该目录下增加 `checkpoints/`、`fingerprint.txt`、`report.md` 等文件。

---

## CLI 使用说明

```
Usage: sciagent [OPTIONS]

选项：
  --cmd TEXT          要执行的训练命令（必填，建议整体用引号包裹）
  --workdir PATH      输出目录，默认当前目录下 `exp`
  --name TEXT         运行名称，参与生成 run_id
  --tail-lines INT    `logs_tail.txt` 中保留的行数，默认 200
  --encoding TEXT     训练进程 stdout 编码，默认 UTF-8
  -c, --config-file   附加配置文件，可多次指定（优先级高于 CLI 参数）
  --help              查看帮助
```

当命令使用 `shell=True` 启动时，保持原样拷贝即可；若包含复杂参数，建议整体用双引号包裹并在内部使用单引号或转义。

---

## 实现原理拆解（M0）

### 1. CLI → Orchestrator

- `typer` 提供命令解析和帮助文档。
- 用户输入解析后传递给 `RunManager`，后者承担一次运行的生命周期管理。

### 2. Sensors：命令与配置采集

- `config_parser.py` 将训练命令拆分为 Token，识别 `--k v` / `--k=v` / `a.b=1` 等格式。
- 支持基本类型推断（`int` / `float` / `bool` / `None`）并构建嵌套字典。
- 支持通过 `--config-file` 追加多个 YAML/JSON 配置文件，后者优先级高于 CLI。

### 3. Memory：Run 目录落盘

- `RunManager` 在 `exp/runs/<timestamp>_<name>` 下创建运行目录。
- 依次写入：
  - `cmd.txt`：原始命令行。
  - `config.json`：包含 `_meta` 信息、程序名称、参数列表以及合并后的配置树。
  - `env.json`：Python 版本、OS、当前工作目录、可选 Git 分支 / commit。
  - `stdout.log`：实时写入的全量标准输出。
  - `logs_tail.txt`：CAP 容量为 `tail_lines` 的队列，保存 stdout 最新 N 行，便于定位故障。
  - `metrics.jsonl`：若 stdout 行满足 JSON 结构会被自动写入，后续模块可以据此绘图或统计。

### 4. Actuators：输出与守护（M0 已具备部分）

- 使用 `rich` 渲染运行摘要表格，并实时输出训练 stdout。
- 捕获 `KeyboardInterrupt` 时优雅终止子进程（Windows 下使用 `CTRL_BREAK_EVENT`，类 Unix 用 `SIGINT`）。
- 未来版本将扩展异常捕获、自动保存、快照策略等能力。

---

## 未来功能设计要点

### M1：配置指纹与 Diff

- 指纹生成：深度归一化配置（key 排序、浮点统一精度、路径去噪）后计算 SHA256。
- Diff 引擎：支持 `sciagent diff --a <runA> --b <runB>`，以 dot-path 形式展示参数变化。

### M2：训练自救

- 针对 `KeyboardInterrupt`、`RuntimeError: CUDA out of memory` 等异常触发自救流程。
- 尝试调用用户脚本保存最新模型；若无法保存，则写入提示性 `resume.json` 供人工介入。

### M3：自动快照

- 解析 JSONL / stdout 指标，识别主指标（默认 `acc` / `val_acc` 可配置）。
- 当指标刷新历史最佳时覆盖 `best.ckpt`。
- 支持 `--ckpt-every-steps` / `--ckpt-every-mins` 等快照策略及 `save_total_limit` 限额。

### M4：一页报告

- 汇总运行摘要、配置树、配置 Diff、指标曲线、异常摘要、可选建议。
- 报告输出为 `report.md` + `curves.png`，可在 5 分钟 Demo 内快速复盘。

### M5：LLM 建议（可选加分）

- 模板化提示，强制引用指标或 Diff，产出三条以内可执行建议。
- 默认关闭自动调参，保证安全性。

---

## 调试与故障排查

1. **缺少 Python 包**：查看 CLI 输出中的报错，使用 `pip install <package>` 安装依赖。
2. **编码问题**：训练脚本输出非 UTF-8 编码文本时，可通过 `--encoding` 指定（Windows 中文终端多为 GBK）。
3. **CUDA 报错**：若提示 “Torch not compiled with CUDA enabled”，确认已安装 GPU 版 PyTorch，或在脚本中增加 `torch.cuda.is_available()` 检查。
4. **长时间训练**：`stdout.log` 为全量日志，`logs_tail.txt` 只保留最新若干行，避免日志过大。
5. **目录冲突**：同一秒内多次运行同名任务时，SciAgent 会自动追加 `-1/-2/...` 后缀。

---

## 贡献指南

欢迎基于以下方向贡献：

- 推进 M1+ 里程碑的实现与测试。
- 扩展日志解析适配（例如 TensorBoard events）。
- 丰富报告模板（可视化主题、LLM 建议等）。
- 编写更多示例训练脚本与演示脚本。

建议流程：

1. Fork 仓库或从当前项目创建分支。
2. 为新增功能补充单元测试或集成测试（若适用）。
3. 更新 README / CHANGELOG 描述改动。
4. 提交 PR 并在描述中关联对应里程碑。

---

## 协议

默认采用 MIT License（如需调整请在此处注明）。

---

## 致谢

- 感谢 RunGuardian / Sci Pilot PRD 提供清晰的产品愿景与拆解。
- 感谢所有测试者反馈编码、依赖、GPU 等问题，帮助我们打磨零侵入体验。


